# メタ広告審査チェッカー - 要件定義書

要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

## 1. プロジェクト概要

### 1.1 成果目標
メタ広告の「テキスト」と「画像」を包括的にチェックするAI審査予測ツール。30秒で審査合否予測・問題箇所の特定・具体的改善案を取得し、審査落ちリスクをゼロに近づける。

### 1.2 成功指標

#### 定量的指標
- **チェック完了速度**: 入力後30秒以内に結果表示
- **審査通過率向上**: アプリ使用後の実際の審査通過率80%以上
- **問題検出精度**: メタ審査基準の主要5項目を網羅的にチェック（テキストオーバーレイ、禁止コンテンツ、肌露出、ビフォーアフター、誇大広告）
- **改善提案の具体性**: 1チェックあたり5-15個の実行可能な改善案
- **ユーザー操作**: チェック完了まで3ステップ以内（入力→アップロード→チェック）

#### 定性的指標
- **インパクト**: 「これ1つで全部チェックできる！」という驚き
- **安心感**: 出稿前に使えば「審査落ちの不安がゼロ」になる信頼性
- **問題解決力**: 審査落ち後に使えば「なぜ落ちたか」が即座にわかる
- **意思決定支援**: 複数案を比較して「最も通りやすい広告」を選べる
- **実用性**: 指摘が具体的で、すぐに修正・再チェックできる

## 2. システム全体像

### 2.1 主要機能一覧
- **広告審査チェック機能**: テキスト+画像の総合AI審査（メタ広告ポリシー準拠）
- **問題箇所の特定**: 具体的にどの部分がNGかを明示
- **改善提案の生成**: コピペで使える具体的な修正案を提供
- **再チェック機能**: 修正後すぐに再度チェック可能

### 2.2 ユーザーロールと権限（MVP: 認証なし）
- **全ユーザー（ゲスト）**: 全機能にアクセス可能（認証不要のパブリックアプリ）

### 2.3 認証・認可要件
- **認証方式**: なし（MVPはパブリックアクセス）
- **セキュリティレベル**: 公開情報のみ扱う
- **管理機能**: なし（MVPでは不要）

**注記**: ユーザー管理・チェック履歴等の機能はPhase 11（機能拡張）で追加予定

## 3. ページ詳細仕様

### 3.1 P-001: メタ広告審査チェッカー（メインページ）

#### 目的
広告素材を入力・アップロードするだけで、メタ広告審査の合否予測と具体的な改善提案を30秒以内に取得できる。審査落ちリスクを大幅に削減し、広告運用者の不安をゼロにする。

#### 主要機能
- 広告テキスト入力エリア（見出し、説明文、CTA）
- 画像アップロード（ドラッグ&ドロップ対応、最大20MB）
- AIチェック実行ボタン
- リアルタイム結果表示
- 再チェック機能（修正後すぐ確認）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| チェック実行 | 広告審査のAI判定 | テキスト（見出し、説明文）+ 画像（任意） | 審査予測結果（合否スコア、問題箇所、改善提案） |

#### 処理フロー
1. ユーザーが広告テキストを入力
2. ユーザーが広告画像をアップロード（オプション）
3. 「チェック実行」ボタンをクリック
4. バックエンドがGemini APIを呼び出し
5. AI審査結果を解析
6. 結果を構造化して表示
   - 総合審査スコア（0-100%）
   - 問題箇所の具体的指摘
   - コピペで使える改善提案
   - 画像内テキスト量（テキストがある場合）
   - NSFW・禁止コンテンツ検出結果
7. ユーザーが修正して再チェック可能

#### データ構造（概念）
```yaml
AdCheckRequest:
  識別子: なし（ステートレス）
  基本情報:
    - headline（見出し）（任意）
    - description（説明文）（任意）
    - cta（コールトゥアクション）（任意）
    - image（画像ファイル）（任意）
  制約:
    - テキストまたは画像の少なくとも1つは必須

AdCheckResponse:
  基本情報:
    - overall_score（総合スコア: 0-100）（必須）
    - status（approved/needs_review/rejected）（必須）
    - confidence（信頼度: 0.0-1.0）（必須）
  問題箇所:
    - violations（違反項目配列）
      - category（カテゴリ名）
      - severity（重要度: high/medium/low）
      - description（具体的な問題点）
      - location（テキスト/画像）
  改善提案:
    - recommendations（改善案配列）
      - before（修正前）
      - after（修正後）
      - reason（理由）
  詳細情報:
    - text_overlay_percentage（画像内テキスト量: 0-100）（画像がある場合）
    - nsfw_detected（NSFW検出: boolean）
    - prohibited_content（禁止コンテンツリスト）
  メタ情報:
    - checked_at（チェック日時）
    - api_used（使用したAPI）
```

---

### 3.2 P-002: 使い方ガイド / よくある質問

#### 目的
初めてのユーザーでも迷わず使える安心感を提供し、メタ広告審査の基礎知識も習得できる。

#### 主要機能
- メタ広告審査の基礎知識（簡潔に）
- アプリの使い方（3ステップで説明）
- よくある質問（FAQ）
- メタ広告ポリシーへのリンク

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 閲覧 | ガイドページの表示 | なし | 使い方ガイド、FAQ、ポリシーリンク |

#### 処理フロー
1. ユーザーがページにアクセス
2. ガイドコンテンツを表示
3. FAQセクションで疑問を解決
4. 必要に応じて外部リンク（Meta公式ポリシー）へ遷移

#### データ構造（概念）
```yaml
GuideContent:
  基本情報:
    - title（タイトル）
    - sections（セクション配列）
      - section_title（セクション名）
      - content（本文）
  FAQ:
    - questions（質問配列）
      - question（質問文）
      - answer（回答）
  外部リンク:
    - meta_policy_url（Meta広告ポリシーURL）
    - meta_help_center_url（Metaヘルプセンター）
```

## 4. データ設計概要

### 4.1 主要エンティティ

**注記**: MVPではデータベースを使用しない（ステートレス設計）。以下は将来拡張時の概念モデル。

```yaml
AdCheckHistory（将来拡張用）:
  概要: チェック履歴を記録（Phase 11で追加予定）
  主要属性:
    - チェック内容（テキスト、画像URL）
    - 結果（スコア、違反項目、改善提案）
    - メタ情報（チェック日時、IPアドレス）
  関連:
    - User（1対多）（認証機能追加時）

User（将来拡張用）:
  概要: ユーザー情報（Phase 11で追加予定）
  主要属性:
    - 基本情報（メール、名前）
    - プラン情報（無料/有料）
    - 利用統計（チェック回数）
  関連:
    - AdCheckHistory（1対多）
```

### 4.2 エンティティ関係図
```
MVP時:
（データベースなし、ステートレス）

将来拡張時:
User ── AdCheckHistory（1対多）
```

### 4.3 バリデーションルール
```yaml
headline（見出し）:
  - ルール: 最大255文字
  - 理由: Meta広告の見出し文字数制限に準拠

description（説明文）:
  - ルール: 最大2000文字
  - 理由: Meta広告の説明文制限に準拠

image:
  - ルール: 最大20MB、形式はJPEG/PNG/WebP
  - 理由: APIの画像サイズ制限とブラウザアップロード制限

テキストまたは画像:
  - ルール: 少なくとも1つは必須
  - 理由: チェック対象がないと判定不可
```

## 5. 制約事項

### 外部API制限
- **Google Gemini API**: 無料枠は1分あたり15リクエスト、1日1,500リクエストまで
- **レスポンス時間**: 画像処理含む場合、最大5秒程度かかる可能性あり
- **画像サイズ**: 最大20MB/枚

### 技術的制約
- **ブラウザ制限**: ファイルアップロードは最大100MB（実質20MBに制限）
- **同時処理**: Cloud Runの無料枠では同時実行数に制限あり
- **審査予測精度**: AIベースのため100%の精度保証は不可能（80-90%の高精度を目指す）

### ビジネス制約
- **Meta審査の変動性**: Meta広告ポリシーは頻繁に更新されるため、定期的なプロンプト調整が必要
- **完全予測の不可能性**: Metaは自動審査+人間審査の2段階のため、完全な予測は不可能

## 5.1 セキュリティ要件

### セキュリティ要件：ブルートフォース攻撃対策

**MVP判定**: 認証機能がないため、ブルートフォース対策は不要（スキップ）

将来的に認証機能を追加する場合（Phase 11）は、以下の対策を実装：
- アカウントベースロックアウト（必須）
- IPベースレート制限（推奨）

### 運用要件：可用性とヘルスチェック

Cloud Run/Kubernetesでの安定運用に必要な要件。

#### ヘルスチェックエンドポイント
- **エンドポイント**: `/api/health`
- **目的**: Cloud Runのliveness/readinessプローブ、監視システムとの連携
- **要件**:
  - HTTP 200（正常）/ 503（異常）でステータス応答
  - 認証不要（パブリックエンドポイント）
  - 5秒以内の応答時間
- **レスポンス例**:
  ```json
  {
    "status": "healthy",
    "timestamp": "2025-01-16T12:00:00Z"
  }
  ```

#### グレースフルシャットダウン
- **目的**: デプロイ時やコンテナ停止時のリクエストドロップ防止
- **要件**:
  - SIGTERMシグナルハンドラーの実装
  - シャットダウン中の新規リクエスト拒否（HTTP 503）
  - 進行中のリクエスト完了まで待機
  - タイムアウト: 8秒（Cloud Runの10秒制限に対応）
- **注意**: SIGINT（Ctrl+C）にも対応し、開発環境での安全な停止を保証

**MVP判定**:
- ヘルスチェック: **必須**（Cloud Run必須機能）
- グレースフルシャットダウン: **必須**（データ整合性保証）

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 広告審査AI判定
**トリガー**: 「チェック実行」ボタンクリック
**フロントエンドAPI**: POST /api/check

**バックエンド内部処理**:
1. リクエストバリデーション
   - テキストまたは画像が存在するか確認
   - 画像サイズ・形式チェック
2. 画像の前処理（画像がある場合）
   - base64エンコード
   - サイズ最適化（必要に応じて）
3. Gemini APIへのリクエスト送信
   - プロンプト構築（メタ広告審査基準を含む）
   - テキスト + 画像を同時送信
4. AI応答の解析
   - JSON形式で結果を抽出
   - スコア計算
5. 補助チェック（オプション）
   - OpenAI Moderation APIで有害コンテンツ検出
   - 結果をマージ
6. レスポンス整形
   - 構造化されたJSON形式で返却

**結果**: 審査予測結果（スコア、問題箇所、改善提案）

**外部サービス依存**: Google Gemini API、OpenAI Moderation API（オプション）

**エラーハンドリング**:
- API呼び出し失敗時: リトライ（最大3回）
- タイムアウト: 30秒でタイムアウト、エラーメッセージ返却
- レート制限: 429エラー時は待機してリトライ

## 7. 技術スタック

```yaml
フロントエンド:
  - フレームワーク: React 18
  - 言語: TypeScript 5
  - UIライブラリ: MUI v6
  - 状態管理: Zustand
  - ルーティング: React Router v6
  - データフェッチ: React Query
  - ビルドツール: Vite 5
  - 画像アップロード: React Dropzone

バックエンド:
  - 言語: Python 3.11+
  - フレームワーク: FastAPI
  - バリデーション: Pydantic v2
  - 画像処理: Pillow
  - AI/ML: google-generativeai, openai（オプション）

データベース:
  - MVP時: なし（ステートレス）
  - 将来拡張時: PostgreSQL (Neon)

インフラ:
  - フロントエンド: Vercel（無料プラン）
  - バックエンド: Google Cloud Run（無料枠）
  - 画像ストレージ: なし（MVP時は直接API送信）

開発ツール:
  - バージョン管理: Git + GitHub
  - CI/CD: GitHub Actions
  - コード品質: ESLint, Prettier, Black
  - テスト: Vitest (フロント), pytest (バック)
```

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Google Gemini API | テキスト+画像の総合審査判定 | https://ai.google.dev/ | 無料枠: 月45,000回 |
| Vercel | フロントエンドホスティング | https://vercel.com/ | 無料プラン（Hobby） |
| Google Cloud | バックエンドホスティング（Cloud Run） | https://cloud.google.com/ | 無料枠: 月200万リクエスト |
| GitHub | コード管理・CI/CD | https://github.com/ | 無料 |

### オプションサービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| OpenAI API | 有害コンテンツ検出（Moderation API） | https://platform.openai.com/ | 完全無料 |
| Google Perspective API | テキスト毒性スコア | https://perspectiveapi.com/ | 完全無料 |
| Neon | PostgreSQLデータベース | https://neon.tech/ | Phase 11拡張時に使用 |

### コストサマリー
- **MVP開発時**: 完全無料（全て無料枠内）
- **本格運用時（月10,000チェック）**: 約600円/月
- **スケール時（月100,000チェック）**: 約7,000円/月

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

### Phase 11で検討可能な拡張機能（実装はしない）
- ユーザー認証・管理機能
- チェック履歴の保存・閲覧
- 統計分析機能（審査通過率の推移等）
- 複数広告の一括チェック
- チーム共有機能
- サブスクリプション・決済機能
- API提供（外部サービス連携）
- 他のプラットフォーム対応（Google広告、Twitter広告等）

---

**最終更新日**: 2025年11月22日
**バージョン**: 1.0（MVP）
