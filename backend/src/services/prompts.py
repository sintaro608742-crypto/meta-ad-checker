"""
============================================
メタ広告審査チェッカー - プロンプトテンプレート
============================================

Meta広告審査基準に基づいたAIプロンプトを構築
"""

from typing import Optional


# --------------------------------------------
# Meta広告審査基準（2025年1月時点）
# --------------------------------------------

META_AD_POLICY = """
# Meta広告審査基準（2025年1月時点）

## 1. 画像内テキスト量（Text Overlay）
- 推奨: 画像内テキストは15%以下が最適
- ガイドライン: 20%以下を強く推奨
- 20%超過: リーチが制限される可能性が高い
- 30%超過: 審査落ちの可能性が非常に高い

## 2. 禁止・制限コンテンツ
以下は特別な許可なく広告不可:
- アルコール（年齢制限あり）
- タバコ、電子タバコ
- 医薬品（処方薬）
- 違法薬物
- 危険なサプリメント
- 武器、弾薬、爆発物
- ギャンブル（年齢制限あり）
- アダルトコンテンツ

## 3. 不適切なコンテンツ（NSFW）
- 過度な肌露出
- 性的示唆が強い表現
- 暴力的な描写
- ショッキングな画像

## 4. ビフォーアフター表現
以下の分野では禁止:
- ダイエット・減量
- 美容整形
- 筋肉増強
- 健康改善

## 5. 誇大広告・誤解を招く表現
- 「100%保証」などの断定表現
- 「業界最安値」「世界一」などの絶対表現（根拠がない場合）
- 「すぐに結果が出る」などの誇張
- 個人の体験談を一般化
- 非現実的な収益保証

## 6. その他のポリシー違反
- 個人情報の不正利用を示唆
- 差別的な表現
- 虚偽または誤解を招く主張
- ターゲティングの悪用を示唆
"""


# --------------------------------------------
# プロンプト構築関数
# --------------------------------------------

def build_meta_ad_review_prompt(
    headline: Optional[str] = None,
    description: Optional[str] = None,
    cta: Optional[str] = None,
    has_image: bool = False,
) -> str:
    """
    Meta広告審査用のプロンプトを構築

    Args:
        headline: 見出し
        description: 説明文
        cta: CTA（Call To Action）
        has_image: 画像が含まれているか

    Returns:
        str: 構築されたプロンプト
    """
    # 広告テキストの組み立て
    ad_text_parts = []
    if headline:
        ad_text_parts.append(f"【見出し】\n{headline}")
    if description:
        ad_text_parts.append(f"【説明文】\n{description}")
    if cta:
        ad_text_parts.append(f"【CTA】\n{cta}")

    ad_text = "\n\n".join(ad_text_parts) if ad_text_parts else "（テキストなし）"

    # 画像の有無
    image_note = "※ 画像が添付されています。画像内のテキスト量、不適切なコンテンツを重点的にチェックしてください。" if has_image else "※ 画像はありません。"

    # プロンプト構築
    prompt = f"""あなたはMeta（Facebook/Instagram）広告の審査エキスパートです。
以下の広告が、Metaの広告ポリシーに準拠しているかを厳格に審査し、JSON形式で結果を返してください。

{META_AD_POLICY}

---

## 審査対象の広告

{ad_text}

{image_note}

---

## 指示

1. **画像内テキスト量の推定**（画像がある場合のみ）:
   - 画像全体に対するテキストの占有率を0-100%で推定
   - 15%以下: 最適
   - 20%以下: 許容範囲
   - 20-30%: 警告（リーチ制限の可能性）
   - 30%超過: 高リスク（審査落ちの可能性大）

2. **禁止コンテンツのチェック**:
   - テキストおよび画像から、禁止・制限カテゴリに該当する要素を検出
   - 医薬品的効能、アルコール、タバコ、ギャンブル等

3. **NSFW（不適切コンテンツ）の検出**:
   - 過度な肌露出、性的表現、暴力的描写の有無

4. **ビフォーアフター表現のチェック**:
   - ダイエット、美容、筋肉増強分野での使用前後比較の有無

5. **誇大広告・誤解を招く表現のチェック**:
   - 断定表現、絶対表現、非現実的な保証の有無

6. **総合判定**:
   - **overall_score**: 0-100点のスコア（100点が最高）
     * 90-100: 優れた広告（承認の可能性が非常に高い）
     * 70-89: 良好（軽微な改善で承認の可能性が高い）
     * 50-69: 要改善（複数の問題あり、審査落ちの可能性あり）
     * 0-49: 重大な問題（審査落ちの可能性が非常に高い）

   - **status**:
     * "approved": スコア70以上、重大な違反なし
     * "needs_review": スコア50-69、または中程度の違反あり
     * "rejected": スコア49以下、または重大な違反あり（禁止コンテンツ、NSFW等）

   - **confidence**: 0.0-1.0の信頼度
     * 0.9以上: 非常に確信がある
     * 0.7-0.89: 確信がある
     * 0.5-0.69: やや不確実
     * 0.5未満: 不確実（要人間確認）

7. **改善提案**:
   - 各違反項目に対して、具体的な修正前後の例を提示
   - ユーザーがすぐに実践できる実用的な提案

---

## 出力形式（必ずこのJSON形式で返してください）

{{
  "overall_score": 85,
  "status": "approved",
  "confidence": 0.92,
  "violations": [
    {{
      "category": "text_overlay",
      "severity": "medium",
      "description": "画像内のテキスト量が約25%です。Metaは20%以下を推奨しているため、リーチが制限される可能性があります。",
      "location": "image"
    }}
  ],
  "recommendations": [
    {{
      "before": "業界最安値で高品質なサービスを提供します",
      "after": "お手頃価格で高品質なサービスを提供します",
      "reason": "「最安値」という絶対表現を避けることで、誇大広告リスクを軽減"
    }}
  ],
  "text_overlay_percentage": 25,
  "nsfw_detected": false,
  "prohibited_content": []
}}

**重要**: 必ずJSON形式のみを返してください。説明文やマークダウンは不要です。
"""

    return prompt
